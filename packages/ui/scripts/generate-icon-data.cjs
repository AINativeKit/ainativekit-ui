#!/usr/bin/env node

/**
 * Icon Data Generator
 *
 * Generates inline SVG data for all icons to enable bundling without external files.
 * Converts SVG files to TypeScript objects with path data.
 *
 * This follows industry best practices (Material-UI, Lucide, Heroicons) where
 * icons are bundled as JavaScript code rather than external SVG files.
 *
 * Usage: node scripts/generate-icon-data.cjs
 */

const fs = require('fs');
const path = require('path');

const PUBLIC_ICONS_DIR = path.join(__dirname, '../public/icons');
const OUTPUT_FILE = path.join(__dirname, '../src/tokens/icon-data.ts');

/**
 * Extract SVG content (paths, viewBox, etc.) from SVG file
 */
function extractSvgData(svgContent) {
  // Extract viewBox
  const viewBoxMatch = svgContent.match(/viewBox="([^"]+)"/);
  const viewBox = viewBoxMatch ? viewBoxMatch[1] : '0 0 24 24';

  // Extract all path elements
  const pathRegex = /<path[^>]*d="([^"]+)"[^>]*\/>/g;
  const paths = [];
  let match;
  while ((match = pathRegex.exec(svgContent)) !== null) {
    paths.push(match[1]);
  }

  return {
    viewBox,
    paths,
  };
}

/**
 * Get all SVG files recursively
 */
function getAllSvgFiles(dir, baseDir = dir, fileList = []) {
  const files = fs.readdirSync(dir);

  files.forEach(file => {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);

    if (stat.isDirectory()) {
      getAllSvgFiles(filePath, baseDir, fileList);
    } else if (path.extname(file) === '.svg') {
      const relativePath = path.relative(baseDir, filePath);
      const category = path.dirname(relativePath);
      const iconName = path.basename(file, '.svg');
      const svgContent = fs.readFileSync(filePath, 'utf-8');
      const svgData = extractSvgData(svgContent);
      fileList.push({ category, iconName, ...svgData });
    }
  });

  return fileList;
}

function generateIconData() {
  console.log('üîÑ Generating inline icon data...');

  const iconFiles = getAllSvgFiles(PUBLIC_ICONS_DIR);

  // Sort by icon name for consistent output
  iconFiles.sort((a, b) => a.iconName.localeCompare(b.iconName));

  // Generate TypeScript code
  let output = `/**
 * Icon Data - Inline SVG Paths
 * Auto-generated by scripts/generate-icon-data.cjs
 * DO NOT EDIT MANUALLY
 *
 * Contains inline SVG path data for all icons to ensure they work
 * when the package is installed via npm without requiring external assets.
 *
 * This follows industry best practices used by Material-UI, Lucide, and Heroicons.
 */

export interface IconData {
  viewBox: string;
  paths: string[];
}

export const iconData: Record<string, IconData> = {\n`;

  iconFiles.forEach(({ iconName, viewBox, paths }) => {
    const pathsStr = paths.map(p => `    '${p}'`).join(',\n');
    output += `  '${iconName}': {\n`;
    output += `    viewBox: '${viewBox}',\n`;
    output += `    paths: [\n${pathsStr}\n    ],\n`;
    output += `  },\n`;
  });

  output += `} as const;\n`;

  // Write output file
  fs.writeFileSync(OUTPUT_FILE, output, 'utf-8');

  const totalIcons = iconFiles.length;
  const outputSize = (output.length / 1024).toFixed(2);
  console.log(`‚úÖ Generated inline data for ${totalIcons} icons`);
  console.log(`üì¶ Output size: ${outputSize} KB`);
  console.log(`üìÅ Output: ${path.relative(process.cwd(), OUTPUT_FILE)}`);
}

// Run the generator
try {
  generateIconData();
} catch (error) {
  console.error('‚ùå Error generating icon data:', error);
  process.exit(1);
}
